<!DOCTYPE html>
<html>
  <head>
    <title>Heatmaps</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <script>

	
	
	
	
	
	
var map;
var heatmap;
var size =10;
var rates = [];
var lats = [];
var lngs = [];
var infoWindows = [];
var markers = [];
var heatMapData = [];	

	
function getData(){
	$.ajax(
	{
	type:"GET",
	url: 'http://54.152.69.195:3000/getDataPoints?lat=-30.5464&lon=-30.2345&rad=300',
	dataType: 'json',
	crossDomain: true,
	success: function(result){
		console.log(result);
    },
	error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    console.log(errorThrown);
                } 
	
	});
}	
	

function popPositions(){
	for(var i=0; i<size; i++){ 
	lats.push(40+i/100.);
    lngs.push(-83.0145 + i/100.);	//          get data
	}
}

function clearPositions(){
	lats = [];
	lngs = [];
}

function popRates(){
	for(var i=0; i<size; i++){
	rates.push(80);              //              get unique data
	}
}

function clearRates(){
	rates = [];
}



function popInfoWindows(){
    
	clearRates();
	popRates();
	
    for(var i=0; i<size; i++){
	 
	//                                               get data
	var contentString = '<div id="content">'+
      '<div id="siteNotice">'+
      '</div>'+
      '<h1 id="firstHeading" class="firstHeading">Dude</h1>'+
      '<div id="bodyContent">'+
      '<p><b>Heartrate:</b>'+rates[i]+'</p>'+
      '</div>'+
      '</div>';
	
	infoWindows.push(new google.maps.InfoWindow({
	content:contentString
	}));
	}
  
}
  
function clearInfoWindows(){
	infoWindows = [];
}
  
function popMarkers(){
	clearPositions();
	popPositions();
	clearInfoWindows();
	popInfoWindows();
	
	var j;
	
	for(i=0; i<size; i++){
		markers.push(new google.maps.Marker({
		map: map,
		position: {lat: lats[i], lng: lngs[i]}, //              Give unique position
		title: 'Person: '+i
		}));
	
		j = i;
		
		//WHY DOES THIS WORK?!?!?!?!
		var frambes = function(i){
			return function(){
				infoWindows[i].open(map, markers[i]);
			}
		};
		
		markers[i].addListener('click', frambes(i));
	}
}

function clearMarkers(){
	for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
    } 
}

function popHeatMapData(){
	for(var i=0; i<size; i++){
		var la = lats[i];
		var ln = lngs[i];
		heatMapData.push({location: new google.maps.LatLng(la, ln), weight: rates[i]});
	}
}

function clearHeatMapData(){
	heatMapData = [];
}



function initMap() {

  var myPos = {lat: 40.0000, lng: -83.0145};

  //creates map
  map = new google.maps.Map(document.getElementById('map'), {
    center: myPos,
    zoom: 15,
	//disableDefaultUI: true
  });
  
  popPositions();
  popHeatMapData();
  
  heatmap = new google.maps.visualization.HeatmapLayer({
  data: heatMapData
  //setMap: map
  });	
  heatmap.setMap(map);
  
  //detects bound changes
  map.addListener('bounds_changed', function() {
    //clear markers off map
	clearMarkers();
	//clear var markers
	markers = [];
    // 3 seconds after the bounds change, do
    window.setTimeout(function() {
      size = 10; //                get data
	  clearHeatMapData();
	  popHeatMapData();
	  popMarkers();
    }, 3000);
  });
  
  //every 10 seconds auto update
  setInterval(function(){
  clearMarkers();
  markers = [];
  size = 10; //                       get data
  popMarkers();
  },
  10000             //10 seconds
  );
  
}






    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHl3jMhfeATzczDEML6pPV5eniiFNP8kA&signed_in=true&libraries=visualization&callback=initMap">
    </script>
  </body>
</html>