<!DOCTYPE html>
<html>
  <head>
    <title>Heatmaps</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <script>

	
	
	
	
	
	
var map;
var heatmap;
var size = 0;
var rates = [];
var lats = [];
var lngs = [];
var infoWindows = [];
var markers = [];
var heatMapData = [];
var data = [];
var startPos;	

	
function getData(func){
	$.ajax(
	{
	type:"GET",
	url: 'http://54.152.69.195:3000/getDataPoints?lat=-30.5464&lon=-30.2345&rad=300',
	dataType: 'json',
	crossDomain: true,
	success: function(result){
		data = result;
		size = data.length;
		func();
		startPos = {lat: result[0].latitude, lng: result[0].longitude}
    },
	error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    console.log(errorThrown);
                } 
	
	});
}	
	

function popPositions(){
	for(var i=0; i<data.length; i++){ 
	lats.push(data[i].latitude);
    lngs.push(data[i].longitude);
	}
}

function clearPositions(){
	lats = [];
	lngs = [];
}

function popRates(){
	for(var i=0; i<data.length; i++){
	rates.push(data[i].rate);
	}
}

function clearRates(){
	rates = [];
}


function popInfoWindows(){
    
	clearRates();
	popRates();
	
    for(var i=0; i<size; i++){
	 
	var contentString = '<div id="content">'+
      '<div id="siteNotice">'+
      '</div>'+
      '<h1 id="firstHeading" class="firstHeading">Person '+i+'</h1>'+
      '<div id="bodyContent">'+
      '<p><b>Heartrate: </b>'+rates[i]+'</p>'+
      '</div>'+
      '</div>';
	
	infoWindows.push(new google.maps.InfoWindow({
	content:contentString
	}));
	}
  
}
  
function clearInfoWindows(){
	infoWindows = [];
}
  
function popMarkers(){
	clearPositions();
	popPositions();
	clearRates();
	popRates();
	clearInfoWindows();
	popInfoWindows();
	
	var j;
	
	for(i=0; i<size; i++){
		markers.push(new google.maps.Marker({
		map: map,
		position: {lat: lats[i], lng: lngs[i]},
		title: 'Person: '+i
		}));
	
		j = i;
		
		//WHY DOES THIS WORK?!?!?!?!
		var frambes = function(i){
			return function(){
				infoWindows[i].open(map, markers[i]);
			}
		};
		
		markers[i].addListener('click', frambes(i));
	}
}

function clearMarkers(){
	for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
    } 
	markers = [];
}

function popHeatMapData(){
	for(var i=0; i<size; i++){
		var la = lats[i];
		var ln = lngs[i];
		var w = rates[i];
	
		
		var obj = {
		location: new google.maps.LatLng(la, ln),
		weight: w
		};
		
		heatMapData.push(obj);
	}
}

function clearHeatMapData(){
	heatMapData = [];
}

function popAll(){
	clearPositions();
	clearRates();
	clearInfoWindows();
	clearHeatMapData();
	clearMarkers();
	popPositions();
	popRates();
	popInfoWindows();
	popMarkers();
	popHeatMapData();
	
}

function drawHeatMap(){
	
  //heatmap.setMap(null);
	
  heatmap = new google.maps.visualization.HeatmapLayer({
	data: heatMapData
  });	
  heatmap.setMap(map);
}

function initMap() {

	
	getData(popAll);
	

   startPos = {lat: 72.23492834234, lng: 48.23948723};

  //creates map
  map = new google.maps.Map(document.getElementById('map'), {
    center: startPos,
    zoom: 15,
	disableDefaultUI: true
  });
  
  drawHeatMap();
  
  
  
  //detects bound changes
  map.addListener('bounds_changed', function() {
    // 3 seconds after the bounds change, do
    window.setTimeout(function() {
      getData(popAll);
	  drawHeatMap();
    }, 3000);
  });
  
  //every 10 seconds auto update
  setInterval(function(){
  getData(popAll);
  drawHeatMap();
  },
  10000             //10 seconds
  );
  
}






    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHl3jMhfeATzczDEML6pPV5eniiFNP8kA&signed_in=true&libraries=visualization&callback=initMap">
    </script>
  </body>
</html>